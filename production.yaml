services:
  api:
    restart: always
    depends_on:
      redis: 
        condition: service_healthy
    container_name: flashlearn-api
    image: 242201285613.dkr.ecr.ap-southeast-1.amazonaws.com/flashlearn-api
    env_file:
      - production.env
    build: ./api/
    command: ["npm", "run", "dev"]
  redis:
    restart: always
    image: redis:latest
    container_name: flashlearn-redis
    healthcheck:
      test: ["CMD", "redis-cli" ,"ping"]
      interval: 5s
      timeout: 5s
      retries: 10
    volumes:
      - redis:/var/lib/redis
    expose:
      - 6379
  nginx:
    restart: always
    depends_on:
      - api
    image: 242201285613.dkr.ecr.ap-southeast-1.amazonaws.com/flashlearn-nginx
    container_name: flashlearn-nginx
    build: ./nginx/
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    ports:
      - 80:80
      - 443:443
  certbot:
    image: certbot/certbot
    container_name: certbot
    depends_on:
      - nginx
    volumes: 
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    command: certonly --webroot -w /var/www/certbot --force-renewal --email flashlearn2025@gmail.com -d flashlearn.io --agree-tos